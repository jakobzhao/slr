<!DOCTYPE html>
<html lang='en'>
<head>
    <title>Sea Level Rise Migration Project</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:title" content="Sea Level Rise Migration Project" />
    <meta property="og:url" content="https://johnsorib.github.io/slr/" />
    <meta property="og:description" content="This is a geovisualization about expected county-to-county human migration in the United States based on 1.8 meters of sea level rise by 2100." />
    <meta property="og:image" content="https://johnsorib.github.io/slr/img/fb-icon.png" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
    <!--favicon-->
    <link rel="icon" href="img/SLR-icon-grey.ico" width="16" height="16" type="image/x-icon"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!--Bootstrap CSS-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <!-- MapboxGL CSS -->
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.35.1/mapbox-gl.css" rel='stylesheet' />
    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="css/main.css" />

    <link href="https://fonts.googleapis.com/css?family=Francois+One" rel="stylesheet">
    <!--jquery-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!--d3-->
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <!--MapboxGL Javascript-->
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.35.1/mapbox-gl.js"></script>
    <!--Leaflet Mapbox Javascript-->
    <script src="https://rawgit.com/mapbox/mapbox-gl-leaflet/master/leaflet-mapbox-gl.js"></script>
    <script src="https://ivansanchez.gitlab.io/Leaflet.TileLayer.GL/src/Leaflet.TileLayer.GL.js"></script>
    <!--Bootstrap Javascript-->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="js/spatialsankey-custom.js"></script>
    <!--geojson library-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
</head>
<body>
<!--Build Bootstrap Navbar-->
<div>
    <nav id="mainNav" class="navbar navbar-default navbar-fixed-top navbar-custom">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span> Menu <i class="fa fa-bars"></i>
                </button>
                <!--<a class="navbar-brand logo"  href="index.html"> <img alt="Home Page" width="18%" src="img/SLR-icon-words-trans.png"></a>-->
                <a class="navbar-brand logo"  href="index.html"> <img alt="Home Page" height="130%" src="img/SLR-icon-trans.png"></a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-left">
                    <li class="dropdown-toggle">
                        <a style="color: black; font-size: x-large; left: -16px" href="index.html">Sea Level Rise Migration Project</a>
                    </li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <!--Choose a state!-->
                    <li class="dropdown">
                        <a style="color: black" href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Zoom to State  <span class="caret"></span></a>
                        <ul class="dropdown-menu scrollable-menu"class="dropdown-menu scrollable-menu" role="menu">
                            <li class="statelist"><a href="javascript:map.setView([32.8067,-86.7911],7);">Alabama</a></li>
                            <li class="statelist"><a href="javascript:map.setView([61.3707,-152.4044],4);">Alaska</a></li>
                            <li class="statelist"><a href="javascript:map.setView([33.7298,-111.4312],7);">Arizona</a></li>
                            <li class="statelist"><a href="javascript:map.setView([34.9697,-92.3731],7);">Arkansas</a></li>
                            <li class="statelist"><a href="javascript:map.setView([38.1162,-119.6816],6);">California</a></li>
                            <li class="statelist"><a href="javascript:map.setView([39.0598,-105.3111],7);">Colorado</a></li>
                            <li class="statelist"><a href="javascript:map.setView([41.5978,-72.7554],9);">Connecticut</a></li>
                            <li class="statelist"><a href="javascript:map.setView([39.3185,-75.5071],7);">Delaware</a></li>
                            <li class="statelist"><a href="javascript:map.setView([38.8974,-77.0268],7);">District of Columbia</a></li>
                            <li class="statelist"><a href="javascript:map.setView([27.7663,-81.6868],7);">Florida</a></li>
                            <li class="statelist"><a href="javascript:map.setView([33.0406,-83.6431],7);">Georgia</a></li>
                            <li class="statelist"><a href="javascript:map.setView([21.0943,-157.4983],7);">Hawaii</a></li>
                            <li class="statelist"><a href="javascript:map.setView([46.2405,-114.4788],6);">Idaho</a></li>
                            <li class="statelist"><a href="javascript:map.setView([40.3495,-88.9861],7);">Illinois</a></li>
                            <li class="statelist"><a href="javascript:map.setView([39.8494,-86.2583],7);">Indiana</a></li>
                            <li class="statelist"><a href="javascript:map.setView([42.0115,-93.2105],7);">Iowa</a></li>
                            <li class="statelist"><a href="javascript:map.setView([38.5266,-98.7265],7);">Kansas</a></li>
                            <li class="statelist"><a href="javascript:map.setView([37.6681,-86.6701],7);">Kentucky</a></li>
                            <li class="statelist"><a href="javascript:map.setView([31.1695,-91.8678],7);">Louisiana</a></li>
                            <li class="statelist"><a href="javascript:map.setView([45.6939,-69.3819],7);">Maine</a></li>
                            <li class="statelist"><a href="javascript:map.setView([39.0639,-76.8021],7);">Maryland</a></li>
                            <li class="statelist"><a href="javascript:map.setView([42.2302,-71.5301],7);">Massachusetts</a></li>
                            <li class="statelist"><a href="javascript:map.setView([43.3266,-84.5361],7);">Michigan</a></li>
                            <li class="statelist"><a href="javascript:map.setView([45.6945,-93.9002],6);">Minnesota</a></li>
                            <li class="statelist"><a href="javascript:map.setView([32.7416,-89.6787],7);">Mississippi</a></li>
                            <li class="statelist"><a href="javascript:map.setView([38.4561,-92.2884],7);">Missouri</a></li>
                            <li class="statelist"><a href="javascript:map.setView([46.9219,-110.4544],7);">Montana</a></li>
                            <li class="statelist"><a href="javascript:map.setView([41.1254,-101.2681],7);">Nebraska</a></li>
                            <li class="statelist"><a href="javascript:map.setView([38.3135,-117.0554],7);">Nevada</a></li>
                            <li class="statelist"><a href="javascript:map.setView([43.4525,-71.5639],7);">New Hampshire</a></li>
                            <li class="statelist"><a href="javascript:map.setView([40.2989,-74.521],7);">New Jersey</a></li>
                            <li class="statelist"><a href="javascript:map.setView([34.8405,-106.2485],7);">New Mexico</a></li>
                            <li class="statelist"><a href="javascript:map.setView([43.1657,-77.9481],7);">New York</a></li>
                            <li class="statelist"><a href="javascript:map.setView([35.6301,-81.8064],7);">North Carolina</a></li>
                            <li class="statelist"><a href="javascript:map.setView([47.5289,-100.784],7);">North Dakota</a></li>
                            <li class="statelist"><a href="javascript:map.setView([40.3888,-82.7649],7);">Ohio</a></li>
                            <li class="statelist"><a href="javascript:map.setView([35.5653,-99.9289],7);">Oklahoma</a></li>
                            <li class="statelist"><a href="javascript:map.setView([44.572,-122.0709],7);">Oregon</a></li>
                            <li class="statelist"><a href="javascript:map.setView([40.5908,-77.2098],7);">Pennsylvania</a></li>
                            <li class="statelist"><a href="javascript:map.setView([41.6809,-71.5118],9);">Rhode Island</a></li>
                            <li class="statelist"><a href="javascript:map.setView([33.8569,-82.945],7);">South Carolina</a></li>
                            <li class="statelist"><a href="javascript:map.setView([44.2998,-100.4388],7);">South Dakota</a></li>
                            <li class="statelist"><a href="javascript:map.setView([35.7478,-86.6923],7);">Tennessee</a></li>
                            <li class="statelist"><a href="javascript:map.setView([31.0545,-99.5635],6);">Texas</a></li>
                            <li class="statelist"><a href="javascript:map.setView([40.15,-111.8624],7);">Utah</a></li>
                            <li class="statelist"><a href="javascript:map.setView([44.0459,-72.7107],7);">Vermont</a></li>
                            <li class="statelist"><a href="javascript:map.setView([37.7693,-78.17],7);">Virginia</a></li>
                            <li class="statelist"><a href="javascript:map.setView([47.4009,-121.4905],7);">Washington</a></li>
                            <li class="statelist"><a href="javascript:map.setView([38.4912,-80.9545],7);">West Virginia</a></li>
                            <li class="statelist"><a href="javascript:map.setView([44.2685,-89.6165],7);">Wisconsin</a></li>
                            <li class="statelist"><a href="javascript:map.setView([42.756,-109.3025],7);">Wyoming</a></li>
                        </ul>
                    </li>
                    <!--Migration Map-->
                    <li class="dropdown-toggle">
                        <a style="color: black" href="index.html">Migration Map</a>
                    </li>
                    <!--About Page-->
                    <li class="dropdown-toggle">
                        <a style="color: black" href="about.html">About</a>
                    </li>
                    <li class="dropdown-toggle git-panel">
                        <a class="gitlink" target="_blank" style="color: black" href="https://github.com/johnsoRiB/slr"><img class="gitlogo" src="img/mark-github.svg"> GitHub</a>
                    </li>
                    <!--Share-->
                    <li class="tweet">
                        <a href="https://twitter.com/share" class="twitter-share-button" data-size="large" data-text="Map shows where millions of people could move due to sea level rise. " data-show-count="false">Tweet</a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
                    </li>
                    <li>
                        <div class="fb-share-button" data-href="https://johnsorib.github.io/slr/" data-layout="button_count" data-size="large" data-mobile-iframe="true"><a class="fb-xfbml-parse-ignore" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fjohnsorib.github.io%2Fslr%2F&amp;src=sdkpreparse">Share</a></div>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>
</div>

<!--Side Panel-->
<div class="info-panel">
    <p><b>Navigate map with cursor or use the "Zoom to State" feature in the navigation bar. Hover or click on hexagon to see migration from the inundated region.</b></p><br/>
    <p>Migration data based on estimates for 1.8 meters of sea level rise, and for estimated U.S. population in 2100.<a target="_blank" href="https://doi.org/10.1038/NCLIMATE3271"><u>(Hauer, 2017)</u></a>. See <a href="about.html"><u>"Team and Project Information"</u></a> for more details.</p>
    <hr>
    <h4>Legend</h4>
    <p><b> Hexagonal Regions:</b></p>
    <i style="background: linear-gradient(to top, red 0%, yellow 100%); height: 45px"></i> <p> Low flow
    <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>&#8597;</span>
    <br> High flow
</p>
    <br>
    <p><b> Meters below sea level in 2100: </b></p>
    <i style="background: #f5f5f3"></i> <p> Above sea level </p>
    <i style="background: rgba(195,188,229,0.41)"></i> <p> 0.0 - 0.6 meters </p>
    <i style="background: rgba(102,90,158,0.4)"></i> <p> 0.6 - 1.2 meters </p>
    <i style="background: rgba(23,0,130,0.51)"></i> <p> 1.2 - 1.8 meters </p>
    <i style="background: rgba(0,159,155,0.4)"></i> <p> The ocean </p>
    <hr>
    <h4>Human Population Flow</h4>
    <div><p id="netflow">Hover or click on hexagon to view migration data.</p></div> <br>
    <!--<div><p id="flowinfo">Hover or click on hexagon to view migration data.</p></div>-->
    <!--<i style="color: #00a5ff">&#xf0c9;</i> <p>Outflow arcs</p>-->
    <i class="glyphicon glyphicon-menu-hamburger" style="color: #00a5ff"></i> <p>Outflow arcs</p>
    <hr>
    <h4>Credits</h4>
    <p> BaseMap: CartoDB | <a href="about.html"><u>Web Map Library</u> |</a></p>
    <p> Created By: <a href="about.html"><u>Students and faculty at Oregon State University</u></a></p>
    <p> Project supported by <a href="http://geoviz.ceoas.oregonstate.edu" target="_blank"> <img src="img/cart-logo.png" style="height:16px;margin-top:-4px"> <u>The Cartography and Geovisualization Group</u></a> at Oregon State University</p>
</div>


<div class="switch-panel">
<label class="switch" >
    <h4 style="color:black">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Toggle&nbsp;Hexagons</h4>
    <input id="hexswitch" type="checkbox">
    <span class="slider round" ></span>
</label>
</div>

<div id="map"></div>
<script>


    (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.9";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));


    var fragmentShader = `
        void main(void) {
            highp vec4 texelColour = texture2D(uTexture0, vec2(vTextureCoords.s, vTextureCoords.t));

            // Height is represented in TENTHS of a meter
            highp float height = (
                texelColour.r * 255.0 * 256.0 * 256.0 +
                texelColour.g * 255.0 * 256.0 +
                texelColour.b * 255.0 )
            -100000.0;
            if (height > 18.0) {
                // ABOVE 1.8m, SAFE...
                gl_FragColor = vec4(0.5, 0.5, 0.5, 0.0);
            } else if (height > 12.0) {
            // ABOVE 1.2m...
                gl_FragColor = vec4(195.0/255.0, 188.0/255.0, 229.0/255.0, 0.4);
            } else if (height > 6.0) {
                // ABOVE 0.6m...
                gl_FragColor = vec4(102.0/255.0, 90.0/255.0, 158.0/255.0, .4);
                            } else if (height > 0.0) {
                // JUST ABOVE SEA LEVEL (>0m)...
                gl_FragColor = vec4(23.0/255.0, 0.0/255.0, 130.0/255.0, .5);
            } else {
                // THE OCEAN
                gl_FragColor = vec4(0.0/255.0, 159.0/255.0, 155.0/255.0, 0.4);
            }
        }
`

    // Set leaflet map
    var map = L.map('map',{zoomControl: false});
//    map.setView([39.8282, -101.5795], 5);
    map.options.minZoom = 3;
    map.options.maxZoom = 14;
    map.fitBounds([
        [49.3, -138.5],
        [22.8, -67.4]
    ]);
    L.control.zoom({position: "bottomright"}).addTo(map);

    // construct the base map.
    L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png').addTo(map);


    var mapboxAccessToken = 'pk.eyJ1IjoibWF0aGV3c24iLCJhIjoiY2oyNWp3NjhwMDA1bDJ3c2NzaGdlOXkxaiJ9.FmtJ5Lf8FFUNAjlgLPNAOA';

    var antitoner = L.tileLayer.gl({
        fragmentShader: fragmentShader,
        tileUrls: ['https://{s}.tiles.mapbox.com/v4/mapbox.terrain-rgb/{z}/{x}/{y}.pngraw?access_token=' + mapboxAccessToken]
    }).addTo(map);

    // Initialize the SVG layer
    var svgLayer = L.svg().addTo(map);

    // Setup svg element to work with
    var svg = d3.select("#map").select("svg");
    var linklayer = svg.append("g").attr("class", "leaflet-zoom-hide");
    var nodelayer = svg.append("g").attr("class", "leaflet-zoom-hide");

    var hexSwitch = $("#hexswitch");


    var controlClick = function(){
        if (hexSwitch.is(":checked")) {
            map.addLayer(svgLayer);
        } else {
            map.removeLayer(svgLayer);
        }
    }

    hexSwitch.on("click", controlClick);

    hexSwitch.click();

    // Load data asynchronosuly
    d3.json("assets/hex-2100.geojson", function (nodes) {
        d3.csv("assets/links-2100.csv", function (links) {
            // Setup spatialsankey object
            var spatialsankey = d3.spatialsankey()
                .lmap(map)
                .nodes(nodes.features)
                .links(links);
            var hex_opened = false;
            var hex_clicked = false;

            var mouseover = function (d) {
                if (hex_opened) return 0;
                // Get link data for this node
                var nodelinks = spatialsankey.links().filter(function (link) {
                    return link.source == d.id;
                });
                // Add data to link layer
                var beziers = linklayer.selectAll("path").data(nodelinks);
                link = spatialsankey.link({'use_arcs': false, 'flip': false});
                // filter
                var linkfilter = function (d) {
                    if (parseFloat(d.flow) > 200) {
                        return "block"
                    } else {
                        return "none"
                    }
                }
                // flowinfo
                $("#flowinfo").html("<b>In: &nbsp &nbsp</b>" + parseInt(d.properties.aggregate_inflows.toString(),10) + "<br><b>Out: </b>" + parseInt(d.properties.aggregate_outflows.toString(),10) + "");
                $("#netflow").html("<b>Net Outflow: </b>" + parseInt((d.properties.aggregate_outflows - d.properties.aggregate_inflows).toString(),10) + "");
                // Draw new links
                beziers.enter()
                    .append("path")
                    .attr("d", link)
                    .attr("class", "curve")
                    .style("fill", "none")
                    .style("display", linkfilter)
                    .attr('id', function (d) {
                        return d.id
                    })
                    .style("stroke-width", function (d) {
                        return Math.pow(parseFloat(d.flow), 1 / 3) /5
                    });
                // Remove old links
                beziers.exit().remove();
                // Hide inactive nodes
                var circleUnderMouse = this;
                hexs.transition().style('opacity', function () {
                    return (this === circleUnderMouse) ? 0.6 : 0;
                });
            }


            var mouseout = function (d) {
                if (!hex_opened) {
                    // Remove links
                    linklayer.selectAll("path").remove();
                    // Show all nodes
                    hexs.transition().style('opacity', 0.3);
                    hex_opened = false;
                }

            }

            var click = function (d) {
                hex_opened = true;
                hex_clicked = true;
            }

            // Draw nodes
            var node = spatialsankey.node();
            var hexs = nodelayer.selectAll("path")
                .data(spatialsankey.nodes())
                .enter()
                .append("path")
                .attr("d", node.geopath)
                .style("fill", node.fill)
                .style("display", node.display)
                .attr("opacity", 0.4)
                .on("mouseover", mouseover)
                .on("mouseout", mouseout)
                .on("click", click);
            var zoomend = function () {
                linklayer.selectAll("path").attr("d", spatialsankey.link());
                hexs.attr("d", node.geopath);
            };
            var mapclick = function (e) {
                if (hex_clicked) {
                    hex_clicked = false;
                } else {
                    linklayer.selectAll("path").remove();
                    // Show all nodes
                    hexs.transition().style('opacity', 0.3);
                    hex_opened = false;
                }
            }
            map.on("zoomend", zoomend);
            map.on("click", mapclick);
        });
    });
</script>
</div>
</body>
</html>
